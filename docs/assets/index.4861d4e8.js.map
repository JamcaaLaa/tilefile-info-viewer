{"version":3,"file":"index.4861d4e8.js","sources":["../../vite/modulepreload-polyfill","../../src/parser/buffer-reader.ts","../../src/parser/tile-file-reader.ts","../../src/main.ts"],"sourcesContent":["const p = function polyfill() {\n    const relList = document.createElement('link').relList;\n    if (relList && relList.supports && relList.supports('modulepreload')) {\n        return;\n    }\n    for (const link of document.querySelectorAll('link[rel=\"modulepreload\"]')) {\n        processPreload(link);\n    }\n    new MutationObserver((mutations) => {\n        for (const mutation of mutations) {\n            if (mutation.type !== 'childList') {\n                continue;\n            }\n            for (const node of mutation.addedNodes) {\n                if (node.tagName === 'LINK' && node.rel === 'modulepreload')\n                    processPreload(node);\n            }\n        }\n    }).observe(document, { childList: true, subtree: true });\n    function getFetchOpts(script) {\n        const fetchOpts = {};\n        if (script.integrity)\n            fetchOpts.integrity = script.integrity;\n        if (script.referrerpolicy)\n            fetchOpts.referrerPolicy = script.referrerpolicy;\n        if (script.crossorigin === 'use-credentials')\n            fetchOpts.credentials = 'include';\n        else if (script.crossorigin === 'anonymous')\n            fetchOpts.credentials = 'omit';\n        else\n            fetchOpts.credentials = 'same-origin';\n        return fetchOpts;\n    }\n    function processPreload(link) {\n        if (link.ep)\n            // ep marker = processed\n            return;\n        link.ep = true;\n        // prepopulate the load record\n        const fetchOpts = getFetchOpts(link);\n        fetch(link.href, fetchOpts);\n    }\n};__VITE_IS_MODERN__&&p();","export type BufferReaderOption = {\r\n  littleEndian?: boolean\r\n}\r\n\r\nexport class BufferReader {\r\n  private _buffer: ArrayBuffer\r\n  private _view: DataView\r\n  private _currentOffset: number = 0\r\n  private _littleEndian: boolean\r\n\r\n  constructor(buffer: ArrayBuffer, options: BufferReaderOption = {}) {\r\n    this._littleEndian = options.littleEndian === undefined ? true : options.littleEndian\r\n    this._buffer = buffer\r\n    this._view = new DataView(buffer)\r\n  }\r\n\r\n  get currentOffset() {\r\n    return this._currentOffset\r\n  }\r\n\r\n  get canGet() {\r\n    return this._currentOffset <= this._buffer.byteLength\r\n  }\r\n\r\n  validate() {\r\n    if (this.canGet) {\r\n      return\r\n    }\r\n    throw new Error('索引越界, 请重新读取数据')\r\n  }\r\n\r\n  reset(offset: number = 0) {\r\n    this._currentOffset = offset\r\n  }\r\n\r\n  reInit(buffer: ArrayBuffer) {\r\n    this._buffer = buffer\r\n    this._view = new DataView(buffer)\r\n    this._currentOffset = 0\r\n  }\r\n\r\n  readByte() {\r\n    const byte = this._view.getUint8(this._currentOffset)\r\n    this._currentOffset++\r\n    return byte\r\n  }\r\n\r\n  readChar() {\r\n    const code = this.readByte()\r\n    return String.fromCharCode(code)\r\n  }\r\n\r\n  readChars(count: number) {\r\n    if (this.currentOffset + count > this._buffer.byteLength) {\r\n      return ''\r\n    }\r\n    const chars = []\r\n    for (let i = 0; i < count; i++) {\r\n      chars.push(this.readChar())\r\n    }\r\n    return chars.join('')\r\n  }\r\n\r\n  readUint8() {\r\n    return this.readByte()\r\n  }\r\n\r\n  readUint16() {\r\n    const num = this._view.getUint16(\r\n      this._currentOffset,\r\n      this._littleEndian\r\n    )\r\n    this._currentOffset += 2\r\n    return num\r\n  }\r\n\r\n  readUint32() {\r\n    const num = this._view.getUint32(\r\n      this._currentOffset,\r\n      this._littleEndian\r\n    ) // 使用小端序读\r\n    this._currentOffset += 4\r\n    return num\r\n  }\r\n\r\n  readFloat32() {\r\n    const num = this._view.getFloat32(\r\n      this._currentOffset,\r\n      this._littleEndian\r\n    )\r\n    this._currentOffset += 4\r\n    return num\r\n  }\r\n\r\n  readFloat64() {\r\n    const num = this._view.getFloat64(\r\n      this._currentOffset,\r\n      this._littleEndian\r\n    )\r\n    this._currentOffset += 8\r\n    return num\r\n  }\r\n\r\n  readInt8() {\r\n    const num = this._view.getInt8(this._currentOffset)\r\n    this._currentOffset++\r\n    return num\r\n  }\r\n\r\n  readInt16() {\r\n    const num = this._view.getInt16(\r\n      this._currentOffset,\r\n      this._littleEndian\r\n    )\r\n    this._currentOffset += 2\r\n    return num\r\n  }\r\n\r\n  readInt32() {\r\n    const num = this._view.getInt32(\r\n      this._currentOffset,\r\n      this._littleEndian\r\n    )\r\n    this._currentOffset += 4\r\n    return num\r\n  }\r\n}\r\n\r\n","import { BufferReader } from './buffer-reader'\r\n\r\nexport const b3dmHeaderLayout = Object.freeze({\r\n  magic: '4c',\r\n  version: 'u32',\r\n  byteLength: 'u32',\r\n  featureTableJSONByteLength: 'u32',\r\n  featureTableBinaryByteLength: 'u32',\r\n  batchTableJSONByteLength: 'u32',\r\n  batchTableBinaryByteLength: 'u32',\r\n})\r\n\r\nexport const i3dmHeaderLayout = Object.freeze({\r\n  magic: '4c',\r\n  version: 'u32',\r\n  byteLength: 'u32',\r\n  featureTableJSONByteLength: 'u32',\r\n  featureTableBinaryByteLength: 'u32',\r\n  batchTableJSONByteLength: 'u32',\r\n  batchTableBinaryByteLength: 'u32',\r\n  gltfFormat: 'u32',\r\n})\r\n\r\nexport const pntsHeaderLayout = Object.freeze({\r\n  magic: '4c',\r\n  version: 'u32',\r\n  byteLength: 'u32',\r\n  featureTableJSONByteLength: 'u32',\r\n  featureTableBinaryByteLength: 'u32',\r\n  batchTableJSONByteLength: 'u32',\r\n  batchTableBinaryByteLength: 'u32',\r\n})\r\n\r\nexport const cmptHeaderLayout = Object.freeze({\r\n  magic: '4c',\r\n  version: 'u32',\r\n  byteLength: 'u32',\r\n})\r\n\r\nexport const glbHeaderLayout = Object.freeze({\r\n  magic: '4c',\r\n  version: 'u32',\r\n  byteLength: 'u32',\r\n  tilesLength: 'u32'\r\n})\r\n\r\nconst stringMatcher = /(\\d+)c/\r\nconst intMatcher = /(i|u)(8|16|32)/\r\nconst floatMatcher = /(f)(32|64)/\r\n\r\nexport type TileFileLayout = { [key: string]: string }\r\n\r\nexport class TileFileReader {\r\n  private _reader: BufferReader\r\n  private _layout: TileFileLayout\r\n  constructor(reader: BufferReader, layout: TileFileLayout) {\r\n    this._layout = layout\r\n    this._reader = reader\r\n  }\r\n\r\n  get layout() {\r\n    return this._layout\r\n  }\r\n  set layout(value) {\r\n    this._layout = value\r\n  }\r\n\r\n  readHead() {\r\n    const pairs = Object.entries(this._layout)\r\n    const resultPairs: [string, string | number][] = []\r\n    for (const [key, pattern] of pairs) {\r\n      resultPairs.push([\r\n        key,\r\n        this.selectReadFunctionAndRead(pattern)\r\n      ])\r\n    }\r\n    return Object.fromEntries(resultPairs)\r\n  }\r\n\r\n  selectReadFunctionAndRead(layout: string) {\r\n    if (stringMatcher.test(layout)) {\r\n      const matchResult = layout.match(stringMatcher)\r\n      if (matchResult) {\r\n        const count = +matchResult[1]\r\n        return this._reader.readChars(count)\r\n      } else {\r\n        return ''\r\n      }\r\n    } else if (intMatcher.test(layout)) {\r\n      const matchResult = layout.match(intMatcher)\r\n      if (matchResult) {\r\n        const type = matchResult[1]\r\n        const bit = +matchResult[2]\r\n        if (type === 'u') {\r\n          if (bit === 8)\r\n            return this._reader.readUint8()\r\n          else if (bit === 16)\r\n            return this._reader.readUint16()\r\n          else if (bit === 32)\r\n            return this._reader.readUint32()\r\n          else\r\n            return 0\r\n        } else {\r\n          if (bit === 8)\r\n            return this._reader.readInt8()\r\n          else if (bit === 16)\r\n            return this._reader.readInt16()\r\n          else if (bit === 32)\r\n            return this._reader.readInt32()\r\n          else\r\n            return 0\r\n        }\r\n      } else {\r\n        return 0\r\n      }\r\n    } else if (floatMatcher.test(layout)) {\r\n      const matchResult = layout.match(floatMatcher)\r\n      if (matchResult) {\r\n        const bit = +matchResult[2]\r\n        if (bit === 32)\r\n          return this._reader.readFloat32()\r\n        else if (bit === 64)\r\n          return this._reader.readFloat64()\r\n        else\r\n          return 0\r\n      } else {\r\n        return ''\r\n      }\r\n    } else {\r\n      return ''\r\n    }\r\n  }\r\n}\r\n\r\n","import {\r\n  BufferReader,\r\n  TileFileReader,\r\n  b3dmHeaderLayout\r\n} from './parser'\r\n\r\nconst root = document.querySelector('#app')\r\nconst readData = async () => {\r\n  const buffer = await fetch('/osgb.b3dm').then(r => r.arrayBuffer())\r\n\r\n  const reader = new BufferReader(buffer)\r\n  const b3dmParser = new TileFileReader(reader, b3dmHeaderLayout)\r\n  const head = b3dmParser.readHead()\r\n  const headJson = JSON.stringify(head, null, 2)\r\n\r\n  if (root) { \r\n    root.innerHTML = `<pre>\r\n${headJson}\r\n</pre>` \r\n  }\r\n}\r\n\r\nreadData()\r\n"],"names":[],"mappings":"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"}